import json

from django.core.management.base import BaseCommand
from apps.findings import models


class Command(BaseCommand):
    help = 'Import vulnerability templates from JSON file'

    def add_arguments(self, parser):
        parser.add_argument('file', type=str)

    def handle(self, *args, **options):
        import_counter = 0
        with open(options["file"], "r") as f:

            for item in json.load(f):
                template, created = models.Template.objects.get_or_create(
                    name=item["name"], description=item["description"], resolution=item["resolution"],
                    ease_of_resolution=item.get('ease_of_resolution', 'undermined'), cve_id=item.get('cve_id'))
                if created:
                    for reference in item.get('references', []):
                        models.Reference.objects.create(template=template, name=reference)
                    import_counter += 1
            self.stdout.write(self.style.SUCCESS('Successfully imported/updated "%s" templates' % import_counter))

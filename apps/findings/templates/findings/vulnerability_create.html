{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Create Vulnerability{% endblock %}


{% block extra_head %}
    <link href="{% static 'css/vendor/select2/select2.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/vulnman/components/select2.css' %}" rel="stylesheet"/>
    <script src="{% static 'js/vendor/select2/select2.min.js' %}"></script>
{% endblock extra_head %}


{% block content %}
    <div class="container mt-3">
        {% include 'forms/formset.html' with title="Vulnerability" %}
    </div>
{% endblock %}


{% block extra_scripts %}

    <script>
        $('#id_asset_type').change(function () {
            $('#id_f_asset option').each(function () {
                $(this).prop("disabled", false);
            });
            $('#id_f_asset option').each(function () {
                if ($(this).text().indexOf("Web Application") === -1 && $('#id_asset_type option:selected').text() === "Web Application") {
                    if ($('#id_f_asset option:selected').text().indexOf("Web Application") === -1) {
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Web Request") === -1 && $('#id_asset_type option:selected').text() === "Web Request") {
                    if ($('#id_f_asset option:selected').text().indexOf("Web Request") === -1) {
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Host") === -1 && $('#id_asset_type option:selected').text() === "Host") {
                    if ($('#id_f_asset option:selected').text().indexOf("Host") === -1) {
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Service") === -1 && $('#id_asset_type option:selected').text() === "Service") {
                    if ($('#id_f_asset option:selected').text().indexOf("Service") === -1) {
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                }
            });
        });

        $('#id_asset_type').change(function () {
            let asset_type = $('#id_asset_type').val();
            let url = "{% url 'api:v1:host-list' %}"
            if (asset_type === "service") {
                url = "{% url 'api:v1:service-list' %}"
            } else if (asset_type === "webapplication") {
                url = "{% url 'api:v1:webapplication-list' %}"
            } else if (asset_type === "webrequest") {
                url = "{% url 'api:v1:webrequest-list' %}"
            }

            $('#id_f_asset').html("")
            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function (data) {
                    var results = data["results"]
                    $.each(results, function (k, v) {
                        console.log(v)
                        $('#id_f_asset').append($('<option>', {
                            value: v.uuid,
                            text: v.display_name
                        }))
                    })

                }
            });
        });
    </script>



    <script>
        $('#id_template_id').select2({
            theme: 'bootstrap-5',
            ajax: {
                url: '{% url 'api:v1:vulnerability-template-list' %}',
                dataType: 'json',
                data: function (params) {
                    // Query parameters will be ?search=[term]&type=public
                    return {search: params.term};
                },
                processResults: function (data) {
                    return {
                        results: jQuery.map(data.results, function (item) {
                            return {
                                id: item.vulnerability_id,
                                text: item.name
                            }
                        })
                    };
                },
            },
            placeholder: 'Template',
            minimumInputLength: 1,
        });
    </script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load verbose_name %}

{% block title %}Create Vulnerability{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/codemirror.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/select2-bootstrap-5-theme.min.css' %}" />
    <script src="{% static 'js/cvss.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/cvss.css' %}" />
    <link rel="stylesheet" href="{% static 'css/codemirror.min.css' %}"/>

    <style>
        .select2-container--bootstrap5 .select2-selection {
            min-height: 40px;
        }
        .select2-search {
            color: #B1B1B1 !important;
            background-color: #222222 !important;
        }

        .select2-search__field {
            color: #B1B1B1 !important;
            background-color: #222222 !important;
        }
        .select2-results {
            background-color: #222222 !important;
        }
        .select2-results li:hover {
            background-color: #18bc9c;
        }

            .CodeMirror {
                color: #B1B1B1;
                background-color: #222222 !important;
                border: 1px solid #515151 !important;
            }
    </style>
{% endblock  %}

{% block breadcrumbs %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'projects:project-list' %}">Projects</a></li>
    <li class="breadcrumb-item"><a href="{% url 'projects:project-detail' project.pk %}">{{ project.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'projects:findings:vulnerability-list' %}">Vulnerabilities</a></li>
    <li class="breadcrumb-item active">Create</li>
</ol>
{% endblock %}


{% block content %}
    {% include 'forms/formset.html' with fileupload=True title="Vulnerability" %}
{% endblock %}


{% block extra_scripts %}
<script>
    cvss_string = document.getElementById("id_cvss_vector");
    var el = document.createElement("div");
    el.setAttribute("id", "cvssboard");
    cvss_string.parentNode.insertBefore(el, cvss_string.nextSibling);
    var c = new CVSS("cvssboard", {
        onchange: function() {
            if (c.get().score !== "?"){
                $("#id_cvss_vector").val(c.get().vector);
            }
        }
    });
    if(cvss_string.value){
        c.set(cvss_string.value);
    }
    </script>

    <script>
        $('#id_asset_type').change(function(){
            $('#id_f_asset option').each(function(){
                $(this).prop("disabled", false);
            });
            $('#id_f_asset option').each(function(){
                if ($(this).text().indexOf("Web Application") === -1 && $('#id_asset_type option:selected').text() === "Web Application"){
                    $(this).prop("disabled", true);
                    if($('#id_f_asset option:selected').text().indexOf("Web Application") === -1){
                        $('#id_f_asset option[value=---').attr('selected', 'selected');
                    }
                } else if ($(this).text().indexOf("Host") === -1 && $('#id_asset_type option:selected').text() === "Host"){
                    $(this).prop("disabled", true);
                    if($('#id_f_asset option:selected').text().indexOf("Host") === -1){
                        $('#id_f_asset option[value="---"').attr('selected', 'selected');
                    }
                } else if ($(this).text().indexOf("Service") === -1 && $('#id_asset_type option:selected').text() === "Service"){
                    $(this).prop("disabled", true);
                    if($('#id_f_asset option:selected').text().indexOf("Service") === -1){
                        $('#id_f_asset option[value="---"').attr('selected', 'selected');
                    }
                } 
            });
        });

    </script>

    <script src="{% static 'js/codemirror/codemirror.min.js' %}"></script>
    <script src="{% static 'js/codemirror/markdown.min.js' %}"></script>
    <script>
        let cm_details = CodeMirror.fromTextArea(document.getElementById('id_details'), {
            mode: "markdown"
        });
        $('#id_details').val("-");
    </script>
{% endblock  %}
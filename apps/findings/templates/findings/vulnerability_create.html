{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load verbose_name %}

{% block title %}Create Vulnerability{% endblock %}

{% block extra_head %}
    <script src="{% static 'js/cvss.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/cvss.css' %}" />
{% endblock  %}

{% block breadcrumbs %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'projects:project-list' %}">Projects</a></li>
    <li class="breadcrumb-item"><a href="{% url 'projects:project-detail' project.pk %}">{{ project.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'projects:findings:vulnerability-list' %}">Vulnerabilities</a></li>
    <li class="breadcrumb-item active">Create</li>
</ol>
{% endblock %}


{% block content %}
    {% include 'forms/formset.html' with fileupload=True title="Vulnerability" %}
    <datalist id="template_suggestion"></datalist>
{% endblock %}


{% block extra_scripts %}
<script>
    cvss_string = document.getElementById("id_cvss_vector");
    var el = document.createElement("div");
    el.setAttribute("id", "cvssboard");
    cvss_string.parentNode.insertBefore(el, cvss_string.nextSibling);
    var c = new CVSS("cvssboard", {
        onchange: function() {
            if (c.get().score !== "?"){
                $("#id_cvss_vector").val(c.get().vector);
            }
        }
    });
    if(cvss_string.value){
        c.set(cvss_string.value);
    }
    </script>

    <script>
        $('#id_asset_type').change(function(){
            $('#id_f_asset option').each(function(){
                $(this).prop("disabled", false);
            });
            $('#id_f_asset option').each(function(){
                if ($(this).text().indexOf("Web Application") === -1 && $('#id_asset_type option:selected').text() === "Web Application"){
                    if($('#id_f_asset option:selected').text().indexOf("Web Application") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Web Request") === -1 && $('#id_asset_type option:selected').text() === "Web Request"){
                    if($('#id_f_asset option:selected').text().indexOf("Web Request") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Host") === -1 && $('#id_asset_type option:selected').text() === "Host"){
                    if($('#id_f_asset option:selected').text().indexOf("Host") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Service") === -1 && $('#id_asset_type option:selected').text() === "Service"){
                    if($('#id_f_asset option:selected').text().indexOf("Service") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } 
            });
        });
    $('#id_template_id').attr("list", "template_suggestion");

    $('#id_template_id').on('input', function(){
        $.ajax({
            type: "GET",
            url: "/api/v1/vulnerabilities/templates/?search=" + $('#id_template_id').val(),
            dataType: "json",
            success: function(data) {
                var results = data["results"];
                $('#template_suggestion').html("");
                $.each(results, function(k, v){
                    console.log(v)
                    $('#template_suggestion').append('<option value="'+ v.vulnerability_id +'">'
                    )
                });
            }
        })
    });

    </script>
{% endblock  %}
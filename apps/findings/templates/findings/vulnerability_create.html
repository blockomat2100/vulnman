{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Create Vulnerability{% endblock %}

{% block content %}
    <div class="container mt-3">
        {% include 'forms/formset.html' with title="Vulnerability" %}
        <datalist id="template_suggestion"></datalist>
    </div>
{% endblock %}


{% block extra_scripts %}

    <script>
        $('#id_asset_type').change(function(){
            $('#id_f_asset option').each(function(){
                $(this).prop("disabled", false);
            });
            $('#id_f_asset option').each(function(){
                if ($(this).text().indexOf("Web Application") === -1 && $('#id_asset_type option:selected').text() === "Web Application"){
                    if($('#id_f_asset option:selected').text().indexOf("Web Application") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Web Request") === -1 && $('#id_asset_type option:selected').text() === "Web Request"){
                    if($('#id_f_asset option:selected').text().indexOf("Web Request") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Host") === -1 && $('#id_asset_type option:selected').text() === "Host"){
                    if($('#id_f_asset option:selected').text().indexOf("Host") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                } else if ($(this).text().indexOf("Service") === -1 && $('#id_asset_type option:selected').text() === "Service"){
                    if($('#id_f_asset option:selected').text().indexOf("Service") === -1){
                        $('#id_f_asset option[value=---]').removeAttr("disabled")
                        $('#id_f_asset option[value=---]').attr('selected', 'selected');
                    }
                    $(this).prop("disabled", true);
                }
            });
        });
    $('#id_template_id').attr("list", "template_suggestion");

    $('#id_template_id').on('input', function(){
        $.ajax({
            type: "GET",
            url: "/api/v1/vulnerabilities/templates/?search=" + $('#id_template_id').val(),
            dataType: "json",
            success: function(data) {
                var results = data["results"];
                $('#template_suggestion').html("");
                $.each(results, function(k, v){
                    console.log(v)
                    $('#template_suggestion').append('<option value="'+ v.vulnerability_id +'">'
                    )
                });
            }
        })
    });

    $('#id_asset_type').change(function(){
        let asset_type = $('#id_asset_type').val();
        let url = "{% url 'api:v1:host-list' %}"
        if( asset_type === "service" ){
            url = "{% url 'api:v1:service-list' %}"
        } else if ( asset_type === "webapplication" ) {
            url = "{% url 'api:v1:webapplication-list' %}"
        } else if ( asset_type === "webrequest" ) {
            url = "{% url 'api:v1:webrequest-list' %}"
        }

        $('#id_f_asset').html("")
        $.ajax({
            type: "GET",
            url: url,
            dataType: "json",
            success: function(data){
                var results = data["results"]
                $.each(results, function(k, v){
                    console.log(v)
                    $('#id_f_asset').append($('<option>', {
                        value: v.uuid,
                        text: v.name
                    }))
                })

            }
        });
    });
    </script>
{% endblock  %}